---
import { getCollection } from "astro:content";
import { getAlbumImages } from "../../utils/albums";
import { Image } from "astro:assets";
import { ViewTransitions } from "astro:transitions";
import Standard from "../../layouts/Standard.astro";
import '../../styles/ImageCaption.css'

export async function getStaticPaths() {
  const albums = await getCollection("albums");

  const paths = Object.values(albums).map((album) => {
    return {
      params: {
        id: album.id,
      },
      props: {
        album,
      },
    };
  });

  return paths;
}

const { album } = Astro.props;
const images = await getAlbumImages(album.id);
---

<Standard title={`${album.data.title}'s Gallery`}>
  <ViewTransitions slot="head" />
  <Fragment slot="body">
    <div class="text-center my-16 mb-32">
      <h1 class="text-3xl xl:text-6xl font-bold">
        {album.data.title}
      </h1>
      <p class="text-lg xl:text-2xl my-4">
        {album.data.description}
      </p>

      <div
        class="mx-auto container my-8 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5"
        id="gallery"
      >
        {
          images.map((image) => (
            <a
              class="contents"
              href={image.src}
              data-pswp-width={image.width}
              data-pswp-height={image.height}
            >
              <Image
                src={image}
                alt={
                  (album.data.images[image.src.split('/').pop()?.split('?')[0] 
                    ?? 'invalid']?.alt  
                    || "No description provided"
                  ) + `
                    <br><strong> Artist: </strong>
                    ${album.data.images[image.src.split('/').pop()?.split('?')[0] ?? 'invalid']?.artist ?? album.data.usual_artist ?? 'Unknown'}
                  `
                }
                format="avif"
                quality={50}
                class="rounded mb-8 border-2 border-transparent hover:border-gray-900 transition-all duration-300 ease-in-out hover:shadow-lg"
                loading="lazy"
              />
            </a>
          ))
        }
      </div>

      <p class="text-lg my-4 text-center">
        <a href="/" class="text-white hover:underline">Go back â†’</a>
      </p>
    </div>
    <script>
      import "photoswipe/style.css";
      import pswpModule from "photoswipe";
      import PhotoSwipeLightbox from "photoswipe/lightbox";
      import PhotoSwipeDynamicCaption from 'photoswipe-dynamic-caption-plugin';

      const lightbox = new PhotoSwipeLightbox({
        pswpModule,
        childSelector: '.pswp-gallery__item',
        children: "a",
        gallery: "#gallery",
      });

      const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
        type: 'below',
      });

      document.addEventListener(
        "astro:page-load",
        () => {
          if (lightbox) lightbox.init();
        },
        { once: false }
      );
    </script>
  </Fragment>
</Standard>